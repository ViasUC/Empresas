import { Injectable } from '@angular/core';
import { BehaviorSubject, Observable, throwError } from 'rxjs';
import { 
  SearchPortfolioState, 
  SearchPortfolioEvent, 
  SearchPortfolioContext,
  SearchFilter,
  SearchCriteria,
  PortfolioResult,
  searchPortfolioFSMConfig
} from '../models/search-portfolio-fsm';

/**
 * Servicio que implementa la máquina de estados para la búsqueda de portafolios
 * Basado en UC-EMP-004 - Buscar Portafolios Candidato
 */
@Injectable({
  providedIn: 'root'
})
export class SearchPortfolioFSMService {
  
  private _currentState = new BehaviorSubject<SearchPortfolioState>(SearchPortfolioState.IDLE);
  private _context = new BehaviorSubject<SearchPortfolioContext>(this.getInitialContext());
  
  public readonly currentState$ = this._currentState.asObservable();
  public readonly context$ = this._context.asObservable();
  
  constructor() {}
  
  /**
   * Obtiene el estado actual
   */
  get currentState(): SearchPortfolioState {
    return this._currentState.value;
  }
  
  /**
   * Obtiene el contexto actual
   */
  get context(): SearchPortfolioContext {
    return this._context.value;
  }
  
  /**
   * Procesa un evento y realiza la transición de estado
   */
  public transition(event: SearchPortfolioEvent, payload?: any): void {
    const currentState = this.currentState;
    const config = searchPortfolioFSMConfig.states[currentState];
    
    if (!config || !config.on[event]) {
      console.warn(`No transition defined for event ${event} in state ${currentState}`);
      return;
    }
    
    const nextState = config.on[event];
    console.log(`FSM: ${currentState} --[${event}]--> ${nextState}`);
    
    // Actualizar contexto basado en el evento
    this.updateContext(event, payload);
    
    // Cambiar estado
    this._currentState.next(nextState);
    
    // Efectos secundarios basados en el nuevo estado
    this.handleStateEntry(nextState, payload);
  }
  
  /**
   * Inicializa la máquina de estados
   */
  public initialize(): void {
    this.transition(SearchPortfolioEvent.INIT);
  }
  
  /**
   * Resetea la máquina de estados
   */
  public reset(): void {
    this._context.next(this.getInitialContext());
    this._currentState.next(SearchPortfolioState.IDLE);
  }
  
  /**
   * Verifica si un evento es válido en el estado actual
   */
  public canTransition(event: SearchPortfolioEvent): boolean {
    const config = searchPortfolioFSMConfig.states[this.currentState];
    return config && !!config.on[event];
  }
  
  /**
   * Obtiene los eventos válidos para el estado actual
   */
  public getValidEvents(): SearchPortfolioEvent[] {
    const config = searchPortfolioFSMConfig.states[this.currentState];
    return config ? Object.keys(config.on) as SearchPortfolioEvent[] : [];
  }
  
  /**
   * Contexto inicial
   */
  private getInitialContext(): SearchPortfolioContext {
    return {
      filters: [],
      searchCriteria: null,
      results: [],
      totalResults: 0,
      currentPage: 1,
      error: null,
      isLoading: false,
      retryCount: 0
    };
  }
  
  /**
   * Actualiza el contexto basado en el evento
   */
  private updateContext(event: SearchPortfolioEvent, payload?: any): void {
    const currentContext = this.context;
    let newContext: SearchPortfolioContext;
    
    switch (event) {
      case SearchPortfolioEvent.INIT:
        newContext = { ...currentContext, isLoading: true, error: null };
        break;
        
      case SearchPortfolioEvent.FILTERS_LOADED:
        newContext = { 
          ...currentContext, 
          filters: payload?.filters || [],
          isLoading: false,
          error: null 
        };
        break;
        
      case SearchPortfolioEvent.SEARCH_REQUESTED:
        newContext = {
          ...currentContext,
          searchCriteria: payload?.criteria || null,
          isLoading: true,
          error: null
        };
        break;
        
      case SearchPortfolioEvent.SEARCH_SUCCESS:
        newContext = {
          ...currentContext,
          results: payload?.results || [],
          totalResults: payload?.totalResults || 0,
          currentPage: payload?.currentPage || 1,
          isLoading: false,
          error: null,
          retryCount: 0
        };
        break;
        
      case SearchPortfolioEvent.AUTH_ERROR:
        newContext = {
          ...currentContext,
          isLoading: false,
          error: 'Error de autenticación. Por favor, inicie sesión nuevamente.'
        };
        break;
        
      case SearchPortfolioEvent.FORBIDDEN_ERROR:
        newContext = {
          ...currentContext,
          isLoading: false,
          error: 'No tiene permisos para realizar esta búsqueda.'
        };
        break;
        
      case SearchPortfolioEvent.VALIDATION_ERROR:
        newContext = {
          ...currentContext,
          isLoading: false,
          error: payload?.message || 'Los filtros de búsqueda no son válidos.'
        };
        break;
        
      case SearchPortfolioEvent.SERVER_ERROR:
        newContext = {
          ...currentContext,
          isLoading: false,
          error: 'Error interno del servidor. Intente nuevamente.',
          retryCount: currentContext.retryCount + 1
        };
        break;
        
      case SearchPortfolioEvent.RETRY:
        newContext = {
          ...currentContext,
          error: null,
          isLoading: true
        };
        break;
        
      case SearchPortfolioEvent.RESET:
        newContext = this.getInitialContext();
        break;
        
      default:
        newContext = currentContext;
    }
    
    this._context.next(newContext);
  }
  
  /**
   * Maneja efectos secundarios al entrar a un estado
   */
  private handleStateEntry(state: SearchPortfolioState, payload?: any): void {
    switch (state) {
      case SearchPortfolioState.LOADING_FILTERS:
        // Aquí se podría disparar la carga de filtros
        console.log('Entrando a LOADING_FILTERS - cargar filtros desde API');
        break;
        
      case SearchPortfolioState.SEARCHING:
        // Aquí se podría disparar la búsqueda
        console.log('Entrando a SEARCHING - ejecutar búsqueda');
        break;
        
      case SearchPortfolioState.ERROR_AUTH:
        // Redirigir a login
        console.log('Error de autenticación - redirigir a login');
        break;
        
      default:
        break;
    }
  }
}